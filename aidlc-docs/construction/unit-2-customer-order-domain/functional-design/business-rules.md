# Business Rules - Unit 2: Customer Order Domain

## Overview

Unit 2 (Customer Order Domain)의 비즈니스 규칙 정의입니다. 고객 주문 프로세스의 제약사항과 정책을 명시합니다.

---

## BR-001: 메뉴 조회 규칙

### BR-001.1: 카테고리 필터링
- 메뉴는 Level 1 카테고리로 필터링 가능
- Level 2 카테고리가 있는 경우 추가 필터링 가능
- 카테고리 없이 전체 메뉴 조회 가능

### BR-001.2: 판매 가능 메뉴만 표시
- `is_available = true`인 메뉴만 고객에게 표시
- 판매 불가 메뉴는 조회 결과에서 제외

### BR-001.3: 메뉴 정렬
- 기본 정렬: 메뉴 ID 순서 (생성 순서)
- 카테고리 내에서 정렬

---

## BR-002: 장바구니 관리 규칙

### BR-002.1: 장바구니 데이터 구조
- 각 장바구니 항목은 다음 정보 포함:
  - 메뉴 ID (참조용)
  - 메뉴 정보 스냅샷 (이름, 가격, 이미지)
  - 선택된 옵션 (옵션 그룹 + 선택 항목)
  - 수량
  - 소계 (가격 + 옵션 가격) × 수량

### BR-002.2: 중복 항목 처리
- 같은 메뉴 + 같은 옵션 조합: 수량 증가
- 같은 메뉴 + 다른 옵션 조합: 별도 항목 추가
- 옵션 비교 로직:
  - 선택된 옵션 그룹 ID와 선택 항목 ID가 모두 일치해야 "같은 옵션"으로 판단
  - 옵션 순서는 무관

### BR-002.3: 수량 조절
- 최소 수량: 1
- 최대 수량: 제한 없음 (UI에서 99까지 권장)
- 수량 0으로 감소 시: 장바구니에서 항목 제거

### BR-002.4: 장바구니 영속성
- SessionStorage에 저장
- 브라우저 탭 닫기 시 삭제
- 페이지 새로고침 시 복원

### BR-002.5: 장바구니 비우기
- 주문 성공 시 자동으로 장바구니 비우기
- 사용자가 수동으로 비우기 가능

---

## BR-003: 메뉴 옵션 선택 규칙

### BR-003.1: 필수 옵션 검증
- `required = true`인 옵션 그룹은 반드시 선택 필요
- 필수 옵션 미선택 시 장바구니 추가 불가

### BR-003.2: 단일/다중 선택
- `allow_multiple = false`: 옵션 그룹 내 1개만 선택 가능
- `allow_multiple = true`: 옵션 그룹 내 여러 개 선택 가능

### BR-003.3: 가격 계산
- 기본 가격 + 선택된 모든 옵션의 `price_adjustment` 합계
- 옵션 가격은 양수, 0, 음수 모두 가능

### BR-003.4: 옵션 선택 UI
- 장바구니 추가 버튼 클릭 시 옵션 선택 모달 표시
- 옵션이 없는 메뉴는 모달 없이 즉시 추가

---

## BR-004: 주문 생성 규칙

### BR-004.1: 주문 생성 전제조건
- 장바구니가 비어있지 않아야 함
- 테이블 세션이 활성화되어 있어야 함 (자동 로그인 상태)

### BR-004.2: 주문 번호 생성
- 형식: `T{테이블번호}-{순차번호}`
- 예시: T01-001, T01-002, T02-001
- 순차 번호는 테이블별로 관리
- 순차 번호는 001부터 시작하여 1씩 증가
- 테이블 세션 종료 시 순차 번호 리셋

### BR-004.3: 주문 항목 생성
- 장바구니의 각 항목을 OrderItem으로 변환
- 메뉴 정보 스냅샷 (이름, 가격) 저장
- 선택된 옵션 정보 스냅샷 저장
- 수량 및 소계 저장

### BR-004.4: 주문 상태 초기화
- 주문 생성 시 상태: `PENDING` (대기중)
- 총 금액: OrderItem 소계의 합계

### BR-004.5: 유효성 검증
- 클라이언트 측: 장바구니 비어있지 않음만 검증
- 서버 측: 메뉴 판매 가능 여부, 가격 일치, 옵션 유효성 검증
- 서버 검증 실패 시: 에러 응답 반환, 장바구니 유지

---

## BR-005: 주문 내역 조회 규칙

### BR-005.1: 조회 범위
- 현재 테이블 세션의 주문만 조회
- 세션 시작 시각 이후 생성된 주문만 포함
- 과거 세션의 주문은 조회 불가 (OrderHistory로 이동됨)

### BR-005.2: 정렬 순서
- 주문 생성 시각 역순 (최신 주문이 위)

### BR-005.3: 주문 상태 표시
- PENDING: 대기중
- CONFIRMED: 확인됨
- PREPARING: 준비중
- READY: 서빙 대기
- COMPLETED: 완료

---

## BR-006: 실시간 업데이트 규칙

### BR-006.1: SSE 연결
- 고객 화면 로드 시 SSE 연결 자동 설정
- 연결 URL: `/api/sse/orders/{table_id}`
- 연결 실패 시: 자동 재연결 시도 (최대 3회)

### BR-006.2: 업데이트 이벤트
- 주문 상태 변경 시: 실시간으로 고객 화면에 반영
- 이벤트 타입: `order_status_changed`
- 이벤트 데이터: 주문 ID, 새로운 상태

### BR-006.3: 연결 유지
- Keep-alive 메시지: 30초마다 전송
- 연결 끊김 감지: 60초 타임아웃
- 재연결 간격: 5초

---

## BR-007: 에러 처리 규칙

### BR-007.1: 에러 메시지
- 모든 에러에 대해 기본 메시지 표시
- 예시: "주문 생성에 실패했습니다. 다시 시도해주세요."
- 에러 타입 구분 없음 (네트워크, 서버, 유효성 모두 동일)

### BR-007.2: 에러 발생 시 동작
- 주문 생성 실패: 장바구니 유지, 에러 메시지 표시
- 메뉴 조회 실패: 빈 목록 표시, 에러 메시지 표시
- SSE 연결 실패: 자동 재연결 시도, 실패 시 에러 메시지 표시

### BR-007.3: 재시도
- 사용자가 수동으로 재시도 가능 (버튼 클릭)
- 자동 재시도 없음 (SSE 연결 제외)

---

## BR-008: 세션 관리 규칙

### BR-008.1: 테이블 자동 로그인
- 관리자가 사전 설정한 테이블 번호로 자동 로그인
- SessionStorage에 테이블 정보 저장
- 세션 유효 기간: 16시간

### BR-008.2: 세션 복원
- 페이지 새로고침 시 SessionStorage에서 세션 정보 복원
- 세션 만료 시: 로그인 화면으로 리다이렉트

### BR-008.3: 세션 종료
- 브라우저 탭 닫기 시 자동 종료
- 관리자가 테이블 세션 종료 시: 고객 화면에서 자동 로그아웃

---

## BR-009: UI/UX 규칙

### BR-009.1: 터치 친화적 UI
- 모든 버튼 최소 크기: 44x44px
- 터치 영역 충분히 확보

### BR-009.2: 시각적 피드백
- 버튼 클릭 시: 시각적 피드백 (색상 변경, 애니메이션)
- 로딩 중: 로딩 스피너 표시
- 성공/실패: 토스트 메시지 또는 모달 표시

### BR-009.3: 장바구니 아이콘
- 장바구니에 담긴 메뉴 개수 표시 (배지)
- 장바구니 비어있을 때: 개수 표시 안 함

---

## BR-010: 데이터 일관성 규칙

### BR-010.1: 메뉴 정보 스냅샷
- 장바구니에 추가 시 메뉴 정보 스냅샷 저장
- 메뉴 가격/이름 변경 시에도 장바구니 정보는 변경되지 않음
- 주문 생성 시 스냅샷 정보를 OrderItem에 저장

### BR-010.2: 가격 계산 일관성
- 장바구니 소계 = (메뉴 가격 + 옵션 가격 합계) × 수량
- 장바구니 총액 = 모든 항목의 소계 합계
- 주문 총액 = OrderItem 소계의 합계

---

**문서 버전**: 1.0  
**작성일**: 2026-02-09  
**상태**: 초안
